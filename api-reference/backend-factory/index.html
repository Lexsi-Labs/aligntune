<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Comprehensive fine-tuning library for SFT and RL training with multi-backend support">
    <meta name="author" content="AlignTune Contributors">
    <link rel="canonical" href="https://aligntune.github.io/api-reference/backend-factory/">
    <link rel="shortcut icon" href="../../img/favicon.ico">

    
<title>Backend Factory - AlignTune</title>


    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../../css/base.min.css" rel="stylesheet">
    <link href="../../css/cinder.min.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/github.min.css">
        
    
    <link href="../../assets/_mkdocstrings.css" rel="stylesheet">
    <link href="../../assets/overrides.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

    
<!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="../../assets/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../assets/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../assets/favicon-16x16.png">
<link rel="manifest" href="../../assets/site.webmanifest">
<link rel="shortcut icon" href="../../assets/favicon.ico">

<!-- Android Chrome Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="../../assets/android-chrome-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="../../assets/android-chrome-512x512.png">

 

</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
 <div class="container">

 <!-- Collapsed navigation -->
 <div class="navbar-header">
 <!-- Expander button -->
 <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
 <span class="sr-only">Toggle navigation</span>
 <span class="icon-bar"></span>
 <span class="icon-bar"></span>
 <span class="icon-bar"></span>
 </button>
 

 <!-- Main title -->

 
 <a class="navbar-brand" href="../..">AlignTune</a>
 
 </div>

 <!-- Expanded navigation -->
 <div class="navbar-collapse collapse">
 <!-- Main navigation -->
 <ul class="nav navbar-nav">
 
 
 <li class="dropdown">
 <a href="#" class="dropdown-toggle" data-toggle="dropdown">Getting Started <b class="caret"></b></a>
 <ul class="dropdown-menu">
 
 
<li >
    <a href="../..">Home</a>
</li>

 
 
<li >
    <a href="../../getting-started/installation/">Installation</a>
</li>

 
 
<li >
    <a href="../../getting-started/quickstart/">Quick Start</a>
</li>

 
 
<li >
    <a href="../../getting-started/basic-concepts/">Basic Concepts</a>
</li>

 
 
<li >
    <a href="../../getting-started/configuration/">Configuration</a>
</li>

 
 
<li >
    <a href="../../getting-started/backend-selection/">Backend Selection</a>
</li>

 
 </ul>
 </li>
 
 
 
 <li class="dropdown">
 <a href="#" class="dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
 <ul class="dropdown-menu">
 
 
<li >
    <a href="../../user-guide/overview/">Overview</a>
</li>

 
 
<li >
    <a href="../../user-guide/sft/">Supervised Fine-Tuning (SFT)</a>
</li>

 
 
<li >
    <a href="../../user-guide/rl/">Reinforcement Learning (RL)</a>
</li>

 
 
<li >
    <a href="../../user-guide/reward-functions/">Reward Functions</a>
</li>

 
 
<li >
    <a href="../../user-guide/reward-model-training/">Reward Model Training</a>
</li>

 
 
<li >
    <a href="../../user-guide/evaluation/">Evaluation</a>
</li>

 
 
<li >
    <a href="../../user-guide/model-management/">Model Management</a>
</li>

 
 
<li >
    <a href="../../user-guide/sample-logging/">Sample Logging</a>
</li>

 
 
<li >
    <a href="../../user-guide/troubleshooting/">Troubleshooting</a>
</li>

 
 
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Algorithms</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../algorithms/overview/">Overview</a>
</li>

        
            
<li >
    <a href="../../algorithms/dpo/">DPO</a>
</li>

        
            
<li >
    <a href="../../algorithms/ppo/">PPO</a>
</li>

        
            
<li >
    <a href="../../algorithms/grpo/">GRPO</a>
</li>

        
            
<li >
    <a href="../../algorithms/gspo/">GSPO</a>
</li>

        
            
<li >
    <a href="../../algorithms/dapo/">DAPO</a>
</li>

        
            
<li >
    <a href="../../algorithms/dr-grpo/">Dr. GRPO</a>
</li>

        
    </ul>
  </li>

 
 
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Backends</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../backends/overview/">Overview</a>
</li>

        
            
<li >
    <a href="../../backends/trl/">TRL Backend</a>
</li>

        
            
<li >
    <a href="../../backends/unsloth/">Unsloth Backend</a>
</li>

        
            
<li >
    <a href="../../backends/comparison/">Comparison</a>
</li>

        
    </ul>
  </li>

 
 </ul>
 </li>
 
 
 
 <li class="dropdown">
 <a href="#" class="dropdown-toggle" data-toggle="dropdown">Advanced Topics <b class="caret"></b></a>
 <ul class="dropdown-menu">
 
 
<li >
    <a href="../../advanced/architecture/">Architecture</a>
</li>

 
 
<li >
    <a href="../../advanced/custom-backends.md">Custom Backends</a>
</li>

 
 
<li >
    <a href="../../advanced/distributed.md">Distributed Training</a>
</li>

 
 
<li >
    <a href="../../advanced/performance.md">Performance Optimization</a>
</li>

 
 </ul>
 </li>
 
 
 
 <li class="dropdown active">
 <a href="#" class="dropdown-toggle" data-toggle="dropdown">API Reference <b class="caret"></b></a>
 <ul class="dropdown-menu">
 
 
<li >
    <a href="../overview/">Overview</a>
</li>

 
 
<li >
    <a href="../core/">Core API</a>
</li>

 
 
<li class="active">
    <a href="./">Backend Factory</a>
</li>

 
 
<li >
    <a href="../configuration/">Configuration Classes</a>
</li>

 
 
<li >
    <a href="../trainers/">Trainers</a>
</li>

 
 </ul>
 </li>
 
 
 
 <li class="dropdown">
 <a href="#" class="dropdown-toggle" data-toggle="dropdown">Examples <b class="caret"></b></a>
 <ul class="dropdown-menu">
 
 
<li >
    <a href="../../examples/overview/">Overview</a>
</li>

 
 
<li >
    <a href="../../examples/sft/">SFT Examples</a>
</li>

 
 
<li >
    <a href="../../examples/rl/">RL Examples</a>
</li>

 
 
<li >
    <a href="../../examples/advanced/">Advanced Examples</a>
</li>

 
 
<li >
    <a href="../../notebooks/">Notebooks</a>
</li>

 
 </ul>
 </li>
 
 
 
 <li class="dropdown">
 <a href="#" class="dropdown-toggle" data-toggle="dropdown">Project <b class="caret"></b></a>
 <ul class="dropdown-menu">
 
 
<li >
    <a href="../../cli-reference/">CLI Reference</a>
</li>

 
 
<li >
    <a href="../../cli/commands/">CLI Commands</a>
</li>

 
 
<li >
    <a href="../../cli/configuration/">CLI Configuration Files</a>
</li>

 
 
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Compatibility</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../unsloth_compatibility/">Unsloth Compatibility</a>
</li>

        
            
<li >
    <a href="../../compatibility/backend-matrix/">Backend Support Matrix</a>
</li>

        
    </ul>
  </li>

 
 
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Contributing</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../contributing/guide/">Contributing Guide</a>
</li>

        
            
<li >
    <a href="../../contributing/code-style/">Code Style</a>
</li>

        
            
<li >
    <a href="../../contributing/testing/">Testing</a>
</li>

        
    </ul>
  </li>

 
 </ul>
 </li>
 
 
 </ul>

 <ul class="nav navbar-nav navbar-right">
 <li>
 <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
 <i class="fas fa-search"></i> Search
 </a>
 </li>
 <li >
 <a rel="prev" href="../core/">
 <i class="fas fa-arrow-left"></i> Previous
 </a>
 </li>
 <li >
 <a rel="next" href="../configuration/">
 Next <i class="fas fa-arrow-right"></i>
 </a>
 </li>
 
 </ul>
 </div>
 </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#backend-factory-api">Backend Factory API</a></li>
            <li class="second-level"><a href="#overview">Overview</a></li>
                
            <li class="second-level"><a href="#backendfactory-class">BackendFactory Class</a></li>
                
                <li class="third-level"><a href="#core.backend_factory.BackendFactory">BackendFactory</a></li>
                <li class="third-level"><a href="#core.backend_factory.BackendFactory.create_trainer">create_trainer</a></li>
                <li class="third-level"><a href="#core.backend_factory.BackendFactory.get_backend_capabilities">get_backend_capabilities</a></li>
                <li class="third-level"><a href="#core.backend_factory.BackendFactory.get_recommended_backend">get_recommended_backend</a></li>
                <li class="third-level"><a href="#core.backend_factory.BackendFactory.is_backend_available">is_backend_available</a></li>
                <li class="third-level"><a href="#core.backend_factory.BackendFactory.list_available_backends">list_available_backends</a></li>
                <li class="third-level"><a href="#core.backend_factory.BackendFactory.register_backend">register_backend</a></li>
            <li class="second-level"><a href="#factory-functions">Factory Functions</a></li>
                
                <li class="third-level"><a href="#create_sft_trainer">create_sft_trainer()</a></li>
                <li class="third-level"><a href="#core.backend_factory.create_sft_trainer">create_sft_trainer</a></li>
                <li class="third-level"><a href="#create_rl_trainer">create_rl_trainer()</a></li>
                <li class="third-level"><a href="#core.backend_factory.create_rl_trainer">create_rl_trainer</a></li>
                <li class="third-level"><a href="#get_backend_status">get_backend_status()</a></li>
                <li class="third-level"><a href="#core.backend_factory.get_backend_status">get_backend_status</a></li>
                <li class="third-level"><a href="#list_backends">list_backends()</a></li>
                <li class="third-level"><a href="#core.backend_factory.list_backends">list_backends</a></li>
            <li class="second-level"><a href="#enums-and-types">Enums and Types</a></li>
                
                <li class="third-level"><a href="#backendtype-enum">BackendType Enum</a></li>
                <li class="third-level"><a href="#core.backend_factory.BackendType">BackendType</a></li>
                <li class="third-level"><a href="#trainingtype-enum">TrainingType Enum</a></li>
                <li class="third-level"><a href="#core.backend_factory.TrainingType">TrainingType</a></li>
                <li class="third-level"><a href="#rlalgorithm-enum">RLAlgorithm Enum</a></li>
                <li class="third-level"><a href="#core.backend_factory.RLAlgorithm">RLAlgorithm</a></li>
                <li class="third-level"><a href="#backendconfig-dataclass">BackendConfig Dataclass</a></li>
                <li class="third-level"><a href="#core.backend_factory.BackendConfig">BackendConfig</a></li>
                <li class="third-level"><a href="#core.backend_factory.BackendConfig.__post_init__">__post_init__</a></li>
            <li class="second-level"><a href="#examples">Examples</a></li>
                
                <li class="third-level"><a href="#sft-with-trl-backend">SFT with TRL Backend</a></li>
                <li class="third-level"><a href="#sft-with-unsloth-backend">SFT with Unsloth Backend</a></li>
                <li class="third-level"><a href="#dpo-training">DPO Training</a></li>
                <li class="third-level"><a href="#ppo-training">PPO Training</a></li>
            <li class="second-level"><a href="#error-handling">Error Handling</a></li>
                
                <li class="third-level"><a href="#backend-not-available">Backend Not Available</a></li>
                <li class="third-level"><a href="#invalid-algorithm">Invalid Algorithm</a></li>
            <li class="second-level"><a href="#next-steps">Next Steps</a></li>
                
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="backend-factory-api">Backend Factory API<a class="headerlink" href="#backend-factory-api" title="Permanent link">&para;</a></h1>
<p>The Backend Factory is the main entry point for creating trainers in AlignTune.</p>
<hr />
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>The <code>BackendFactory</code> provides functions to create SFT and RL trainers with automatic backend selection and fallback handling.</p>
<hr />
<h2 id="backendfactory-class">BackendFactory Class<a class="headerlink" href="#backendfactory-class" title="Permanent link">&para;</a></h2>
<p>Complete API reference for the <code>BackendFactory</code> class.</p>


<div class="doc doc-object doc-class">



<a id="core.backend_factory.BackendFactory"></a>
    <div class="doc doc-contents first">



        <p>Factory for creating training backends.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BackendFactory</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for creating training backends.&quot;&quot;&quot;</span>

    <span class="c1"># Registry of available backends</span>
    <span class="n">_backends</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">TrainerBase</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_backend</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> 
        <span class="n">training_type</span><span class="p">:</span> <span class="n">TrainingType</span><span class="p">,</span> 
        <span class="n">backend</span><span class="p">:</span> <span class="n">BackendType</span><span class="p">,</span> 
        <span class="n">algorithm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RLAlgorithm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">trainer_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">TrainerBase</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a backend trainer class.&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">training_type</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_backends</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">trainer_class</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Registered backend: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">trainer_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_select_best_backend</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">backend_config</span><span class="p">:</span> <span class="n">BackendConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BackendConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select the best available backend with fallback.&quot;&quot;&quot;</span>
        <span class="c1"># Check if requested backend is available</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_is_backend_available</span><span class="p">(</span><span class="n">backend_config</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">backend_config</span>

        <span class="c1"># Try fallback backends</span>
        <span class="k">if</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">fallback_enabled</span><span class="p">:</span>
            <span class="n">fallback_order</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_fallback_order</span><span class="p">(</span><span class="n">backend_config</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">fallback_backend</span> <span class="ow">in</span> <span class="n">fallback_order</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_is_backend_available</span><span class="p">(</span><span class="n">fallback_backend</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requested backend </span><span class="si">{</span><span class="n">backend_config</span><span class="o">.</span><span class="n">backend</span><span class="si">}</span><span class="s2"> not available, &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;falling back to </span><span class="si">{</span><span class="n">fallback_backend</span><span class="o">.</span><span class="n">backend</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">fallback_backend</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No available backend for </span><span class="si">{</span><span class="n">backend_config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_backend_available</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">backend_config</span><span class="p">:</span> <span class="n">BackendConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a backend is available.&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">backend_config</span><span class="o">.</span><span class="n">training_type</span><span class="p">,</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
        <span class="n">trainer_class</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_backends</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trainer_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check if the trainer class can be instantiated</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">trainer_class</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_fallback_order</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">backend_config</span><span class="p">:</span> <span class="n">BackendConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get fallback order for backend selection.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">training_type</span> <span class="o">==</span> <span class="n">TrainingType</span><span class="o">.</span><span class="n">SFT</span><span class="p">:</span>
            <span class="c1"># SFT fallback order: Unsloth -&gt; TRL</span>
            <span class="n">fallbacks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">BackendConfig</span><span class="p">(</span><span class="n">TrainingType</span><span class="o">.</span><span class="n">SFT</span><span class="p">,</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">UNSLOTH</span><span class="p">),</span>
                <span class="n">BackendConfig</span><span class="p">(</span><span class="n">TrainingType</span><span class="o">.</span><span class="n">SFT</span><span class="p">,</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">TRL</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># RL</span>
            <span class="c1"># RL fallback order: Unsloth -&gt; TRL</span>
            <span class="n">fallbacks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">BackendConfig</span><span class="p">(</span><span class="n">TrainingType</span><span class="o">.</span><span class="n">RL</span><span class="p">,</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">UNSLOTH</span><span class="p">,</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">algorithm</span><span class="p">),</span>
                <span class="n">BackendConfig</span><span class="p">(</span><span class="n">TrainingType</span><span class="o">.</span><span class="n">RL</span><span class="p">,</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">TRL</span><span class="p">,</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">algorithm</span><span class="p">),</span>
            <span class="p">]</span>

        <span class="c1"># Remove the original backend from fallbacks</span>
        <span class="n">fallbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">fb</span> <span class="k">for</span> <span class="n">fb</span> <span class="ow">in</span> <span class="n">fallbacks</span> <span class="k">if</span> <span class="n">fb</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">backend</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fallbacks</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_available_backends</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List all available backends.&quot;&quot;&quot;</span>
        <span class="n">available</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;SFT&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;RL&quot;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">training_type</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">),</span> <span class="n">trainer_class</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_backends</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trainer_class</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">training_type</span> <span class="o">==</span> <span class="n">TrainingType</span><span class="o">.</span><span class="n">SFT</span><span class="p">:</span>
                        <span class="n">available</span><span class="p">[</span><span class="s2">&quot;SFT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># RL</span>
                        <span class="k">if</span> <span class="n">algorithm</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available</span><span class="p">[</span><span class="s2">&quot;RL&quot;</span><span class="p">]:</span>
                            <span class="n">available</span><span class="p">[</span><span class="s2">&quot;RL&quot;</span><span class="p">][</span><span class="n">algorithm</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">available</span><span class="p">[</span><span class="s2">&quot;RL&quot;</span><span class="p">][</span><span class="n">algorithm</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="n">available</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_backend_available</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend_type</span><span class="p">:</span> <span class="n">BackendType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a specific backend type is available.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">backend_type</span> <span class="o">==</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">TRL</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">TRL_AVAILABLE</span>
            <span class="k">elif</span> <span class="n">backend_type</span> <span class="o">==</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">UNSLOTH</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">UNSLOTH_AVAILABLE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_backend_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend_type</span><span class="p">:</span> <span class="n">BackendType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get capabilities for a specific backend type.&quot;&quot;&quot;</span>
        <span class="n">capabilities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">backend_type</span> <span class="o">==</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">TRL</span> <span class="ow">and</span> <span class="n">TRL_AVAILABLE</span><span class="p">:</span>
            <span class="n">capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sft&#39;</span><span class="p">,</span> <span class="s1">&#39;dpo&#39;</span><span class="p">,</span> <span class="s1">&#39;ppo&#39;</span><span class="p">,</span> <span class="s1">&#39;grpo&#39;</span><span class="p">,</span> <span class="s1">&#39;gspo&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">backend_type</span> <span class="o">==</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">UNSLOTH</span> <span class="ow">and</span> <span class="p">(</span><span class="n">UNSLOTH_AVAILABLE</span> <span class="ow">or</span> <span class="n">_check_unsloth_available</span><span class="p">()):</span>
            <span class="n">capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sft&#39;</span><span class="p">,</span> <span class="s1">&#39;dpo&#39;</span><span class="p">,</span> <span class="s1">&#39;ppo&#39;</span><span class="p">,</span> <span class="s1">&#39;grpo&#39;</span><span class="p">,</span> <span class="s1">&#39;gspo&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">capabilities</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_recommended_backend</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">training_type</span><span class="p">:</span> <span class="n">TrainingType</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RLAlgorithm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BackendConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get recommended backend for given training type and algorithm.&quot;&quot;&quot;</span>
        <span class="c1"># print(cls)</span>
        <span class="k">if</span> <span class="n">training_type</span> <span class="o">==</span> <span class="n">TrainingType</span><span class="o">.</span><span class="n">SFT</span><span class="p">:</span>
            <span class="c1"># For SFT: Unsloth is best, then TRL</span>
            <span class="k">for</span> <span class="n">backend</span> <span class="ow">in</span> <span class="p">[</span><span class="n">BackendType</span><span class="o">.</span><span class="n">UNSLOTH</span><span class="p">,</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">TRL</span><span class="p">]:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">BackendConfig</span><span class="p">(</span><span class="n">training_type</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_is_backend_available</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">config</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># RL</span>
            <span class="c1"># For RL: Unsloth+TRL is best, then TRL</span>
            <span class="k">for</span> <span class="n">backend</span> <span class="ow">in</span> <span class="p">[</span><span class="n">BackendType</span><span class="o">.</span><span class="n">UNSLOTH</span><span class="p">,</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">TRL</span><span class="p">]:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">BackendConfig</span><span class="p">(</span><span class="n">training_type</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_is_backend_available</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">config</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No available backend for </span><span class="si">{</span><span class="n">training_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">algorithm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_trainer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">backend_config</span><span class="p">:</span> <span class="n">BackendConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TrainerBase</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a trainer instance based on backend configuration.&quot;&quot;&quot;</span>

        <span class="c1"># ==================== CLASSIFICATION ROUTING ====================</span>
        <span class="c1"># Check for classification tasks - route to ClassificationTrainer</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;dataset&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;task_type&#39;</span><span class="p">):</span>
            <span class="n">task_type</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">task_type</span>

            <span class="c1"># For classification, use ClassificationTrainer (NOT TRL)</span>
            <span class="k">if</span> <span class="n">task_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">TaskType</span><span class="o">.</span><span class="n">TEXT_CLASSIFICATION</span><span class="p">,</span> <span class="n">TaskType</span><span class="o">.</span><span class="n">TOKEN_CLASSIFICATION</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">aligntune.backends.trl.sft.Classification_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClassificationTrainer</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Using ClassificationTrainer for </span><span class="si">{</span><span class="n">task_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">ClassificationTrainer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ ClassificationTrainer import failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Make sure the file exists at:&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;  backends/trl/sft/Classification_trainer.py&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;ClassificationTrainer not found. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
        <span class="c1"># ==================== END CLASSIFICATION ROUTING ====================</span>

        <span class="c1"># Normal backend routing for non-classification tasks</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">backend_config</span><span class="o">.</span><span class="n">training_type</span><span class="p">,</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_backends</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No backend registered for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">trainer_class</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_backends</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Check if backend is available</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trainer_class</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">fallback_enabled</span><span class="p">:</span>
                <span class="c1"># Try fallback backends</span>
                <span class="n">fallback_config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_recommended_backend</span><span class="p">(</span><span class="n">backend_config</span><span class="o">.</span><span class="n">training_type</span><span class="p">,</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fallback_config</span> <span class="o">!=</span> <span class="n">backend_config</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backend </span><span class="si">{</span><span class="n">backend_config</span><span class="o">.</span><span class="n">backend</span><span class="si">}</span><span class="s2"> not available, falling back to </span><span class="si">{</span><span class="n">fallback_config</span><span class="o">.</span><span class="n">backend</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create_trainer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">fallback_config</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backend </span><span class="si">{</span><span class="n">backend_config</span><span class="o">.</span><span class="n">backend</span><span class="si">}</span><span class="s2"> is not available&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">trainer_class</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="core.backend_factory.BackendFactory.create_trainer" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_trainer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">backend_config</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#core.backend_factory.BackendFactory.create_trainer" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Create a trainer instance based on backend configuration.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_trainer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">backend_config</span><span class="p">:</span> <span class="n">BackendConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TrainerBase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a trainer instance based on backend configuration.&quot;&quot;&quot;</span>

    <span class="c1"># ==================== CLASSIFICATION ROUTING ====================</span>
    <span class="c1"># Check for classification tasks - route to ClassificationTrainer</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;dataset&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;task_type&#39;</span><span class="p">):</span>
        <span class="n">task_type</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">task_type</span>

        <span class="c1"># For classification, use ClassificationTrainer (NOT TRL)</span>
        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">TaskType</span><span class="o">.</span><span class="n">TEXT_CLASSIFICATION</span><span class="p">,</span> <span class="n">TaskType</span><span class="o">.</span><span class="n">TOKEN_CLASSIFICATION</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">aligntune.backends.trl.sft.Classification_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClassificationTrainer</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Using ClassificationTrainer for </span><span class="si">{</span><span class="n">task_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ClassificationTrainer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ ClassificationTrainer import failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Make sure the file exists at:&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;  backends/trl/sft/Classification_trainer.py&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ClassificationTrainer not found. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
    <span class="c1"># ==================== END CLASSIFICATION ROUTING ====================</span>

    <span class="c1"># Normal backend routing for non-classification tasks</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">backend_config</span><span class="o">.</span><span class="n">training_type</span><span class="p">,</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_backends</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No backend registered for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">trainer_class</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_backends</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="c1"># Check if backend is available</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">trainer_class</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">fallback_enabled</span><span class="p">:</span>
            <span class="c1"># Try fallback backends</span>
            <span class="n">fallback_config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_recommended_backend</span><span class="p">(</span><span class="n">backend_config</span><span class="o">.</span><span class="n">training_type</span><span class="p">,</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fallback_config</span> <span class="o">!=</span> <span class="n">backend_config</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backend </span><span class="si">{</span><span class="n">backend_config</span><span class="o">.</span><span class="n">backend</span><span class="si">}</span><span class="s2"> not available, falling back to </span><span class="si">{</span><span class="n">fallback_config</span><span class="o">.</span><span class="n">backend</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create_trainer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">fallback_config</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backend </span><span class="si">{</span><span class="n">backend_config</span><span class="o">.</span><span class="n">backend</span><span class="si">}</span><span class="s2"> is not available&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">trainer_class</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="core.backend_factory.BackendFactory.get_backend_capabilities" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_backend_capabilities</span><span class="p">(</span><span class="n">backend_type</span><span class="p">)</span></code>

<a href="#core.backend_factory.BackendFactory.get_backend_capabilities" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get capabilities for a specific backend type.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_backend_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend_type</span><span class="p">:</span> <span class="n">BackendType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get capabilities for a specific backend type.&quot;&quot;&quot;</span>
    <span class="n">capabilities</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">backend_type</span> <span class="o">==</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">TRL</span> <span class="ow">and</span> <span class="n">TRL_AVAILABLE</span><span class="p">:</span>
        <span class="n">capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sft&#39;</span><span class="p">,</span> <span class="s1">&#39;dpo&#39;</span><span class="p">,</span> <span class="s1">&#39;ppo&#39;</span><span class="p">,</span> <span class="s1">&#39;grpo&#39;</span><span class="p">,</span> <span class="s1">&#39;gspo&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">backend_type</span> <span class="o">==</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">UNSLOTH</span> <span class="ow">and</span> <span class="p">(</span><span class="n">UNSLOTH_AVAILABLE</span> <span class="ow">or</span> <span class="n">_check_unsloth_available</span><span class="p">()):</span>
        <span class="n">capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sft&#39;</span><span class="p">,</span> <span class="s1">&#39;dpo&#39;</span><span class="p">,</span> <span class="s1">&#39;ppo&#39;</span><span class="p">,</span> <span class="s1">&#39;grpo&#39;</span><span class="p">,</span> <span class="s1">&#39;gspo&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">capabilities</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="core.backend_factory.BackendFactory.get_recommended_backend" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_recommended_backend</span><span class="p">(</span><span class="n">training_type</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#core.backend_factory.BackendFactory.get_recommended_backend" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get recommended backend for given training type and algorithm.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_recommended_backend</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">training_type</span><span class="p">:</span> <span class="n">TrainingType</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RLAlgorithm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BackendConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get recommended backend for given training type and algorithm.&quot;&quot;&quot;</span>
    <span class="c1"># print(cls)</span>
    <span class="k">if</span> <span class="n">training_type</span> <span class="o">==</span> <span class="n">TrainingType</span><span class="o">.</span><span class="n">SFT</span><span class="p">:</span>
        <span class="c1"># For SFT: Unsloth is best, then TRL</span>
        <span class="k">for</span> <span class="n">backend</span> <span class="ow">in</span> <span class="p">[</span><span class="n">BackendType</span><span class="o">.</span><span class="n">UNSLOTH</span><span class="p">,</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">TRL</span><span class="p">]:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">BackendConfig</span><span class="p">(</span><span class="n">training_type</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_is_backend_available</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">config</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># RL</span>
        <span class="c1"># For RL: Unsloth+TRL is best, then TRL</span>
        <span class="k">for</span> <span class="n">backend</span> <span class="ow">in</span> <span class="p">[</span><span class="n">BackendType</span><span class="o">.</span><span class="n">UNSLOTH</span><span class="p">,</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">TRL</span><span class="p">]:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">BackendConfig</span><span class="p">(</span><span class="n">training_type</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_is_backend_available</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">config</span>

    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No available backend for </span><span class="si">{</span><span class="n">training_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">algorithm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="core.backend_factory.BackendFactory.is_backend_available" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_backend_available</span><span class="p">(</span><span class="n">backend_type</span><span class="p">)</span></code>

<a href="#core.backend_factory.BackendFactory.is_backend_available" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Check if a specific backend type is available.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_backend_available</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend_type</span><span class="p">:</span> <span class="n">BackendType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a specific backend type is available.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">backend_type</span> <span class="o">==</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">TRL</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TRL_AVAILABLE</span>
        <span class="k">elif</span> <span class="n">backend_type</span> <span class="o">==</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">UNSLOTH</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">UNSLOTH_AVAILABLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="core.backend_factory.BackendFactory.list_available_backends" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">list_available_backends</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#core.backend_factory.BackendFactory.list_available_backends" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>List all available backends.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_available_backends</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all available backends.&quot;&quot;&quot;</span>
    <span class="n">available</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;SFT&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;RL&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">training_type</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">),</span> <span class="n">trainer_class</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_backends</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trainer_class</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">training_type</span> <span class="o">==</span> <span class="n">TrainingType</span><span class="o">.</span><span class="n">SFT</span><span class="p">:</span>
                    <span class="n">available</span><span class="p">[</span><span class="s2">&quot;SFT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># RL</span>
                    <span class="k">if</span> <span class="n">algorithm</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available</span><span class="p">[</span><span class="s2">&quot;RL&quot;</span><span class="p">]:</span>
                        <span class="n">available</span><span class="p">[</span><span class="s2">&quot;RL&quot;</span><span class="p">][</span><span class="n">algorithm</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">available</span><span class="p">[</span><span class="s2">&quot;RL&quot;</span><span class="p">][</span><span class="n">algorithm</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="n">available</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="core.backend_factory.BackendFactory.register_backend" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">register_backend</span><span class="p">(</span><span class="n">training_type</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trainer_class</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#core.backend_factory.BackendFactory.register_backend" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Register a backend trainer class.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">register_backend</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> 
    <span class="n">training_type</span><span class="p">:</span> <span class="n">TrainingType</span><span class="p">,</span> 
    <span class="n">backend</span><span class="p">:</span> <span class="n">BackendType</span><span class="p">,</span> 
    <span class="n">algorithm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RLAlgorithm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">trainer_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">TrainerBase</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register a backend trainer class.&quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">training_type</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">)</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">_backends</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">trainer_class</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Registered backend: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">trainer_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>options:
 show_source: true
 heading_level: 3</p>
<hr />
<h2 id="factory-functions">Factory Functions<a class="headerlink" href="#factory-functions" title="Permanent link">&para;</a></h2>
<h3 id="create_sft_trainer"><code>create_sft_trainer()</code><a class="headerlink" href="#create_sft_trainer" title="Permanent link">&para;</a></h3>
<p>Create a Supervised Fine-Tuning trainer.</p>


<div class="doc doc-object doc-function">



<a id="core.backend_factory.create_sft_trainer"></a>
    <div class="doc doc-contents first">

        <p>Create SFT trainer with specified backend and parameters.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_sft_trainer</span><span class="p">(</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dataset_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./output&quot;</span><span class="p">,</span>
    <span class="n">num_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2e-4</span><span class="p">,</span>
    <span class="n">max_seq_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
    <span class="n">max_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1">#</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TrainerBase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create SFT trainer with specified backend and parameters.&quot;&quot;&quot;</span>


    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>  <span class="c1"># ← Use load_config from config_utils</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># Parse config to unified format</span>
        <span class="n">parsed_config</span> <span class="o">=</span> <span class="n">parse_config_to_unified</span><span class="p">(</span><span class="n">config_dict</span><span class="p">,</span> <span class="n">training_type</span><span class="o">=</span><span class="s2">&quot;sft&quot;</span><span class="p">)</span>  <span class="c1"># ← Use the function</span>

        <span class="c1"># Merge: parsed_config as base, kwargs override</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">parsed_config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">merged</span>

        <span class="c1"># Extract required parameters</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">dataset_name</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dataset_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;backend&#39;</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
    <span class="c1"># Validate required parameters</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;model_name must be provided either as argument or in config&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset_name must be provided either as argument or in config&quot;</span><span class="p">)</span>
    <span class="c1"># Create configuration</span>
    <span class="c1"># Build model config kwargs, only including precision if explicitly provided</span>
    <span class="n">model_config_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name_or_path&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
        <span class="s2">&quot;max_seq_length&quot;</span><span class="p">:</span> <span class="n">max_seq_length</span><span class="p">,</span>
        <span class="s2">&quot;quantization&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quantization&#39;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="s2">&quot;use_unsloth&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_unsloth&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="s2">&quot;peft_enabled&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_peft&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;peft_enabled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
        <span class="s2">&quot;lora_rank&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lora_r&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
        <span class="s2">&quot;lora_alpha&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lora_alpha&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
        <span class="s2">&quot;lora_dropout&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lora_dropout&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
        <span class="s2">&quot;target_modules&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lora_target_modules&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s2">&quot;bias&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lora_bias&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">),</span>
        <span class="s2">&quot;attn_implementation&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attn_implementation&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">),</span>
        <span class="s2">&quot;max_memory&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_memory&#39;</span><span class="p">),</span>
        <span class="s2">&quot;use_gradient_checkpointing&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_gradient_checkpointing&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;num_labels&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_labels&#39;</span><span class="p">),</span>  <span class="c1"># For classification tasks</span>
        <span class="s2">&quot;model_init_kwargs&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_init_kwargs&#39;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="s2">&quot;device_map&quot;</span><span class="p">:</span>  <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;device_map&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">),</span>
        <span class="s2">&quot;trust_remote_code&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trust_remote_code&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="c1"># Only add precision if explicitly provided (otherwise use default from ModelConfig)</span>
    <span class="k">if</span> <span class="s1">&#39;precision&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Validate precision value</span>
        <span class="n">precision_value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">precision_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Convert string to PrecisionType enum</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.sft.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">PrecisionType</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">precision_value</span> <span class="o">=</span> <span class="n">PrecisionType</span><span class="p">(</span><span class="n">precision_value</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid precision &#39;</span><span class="si">{</span><span class="n">precision_value</span><span class="si">}</span><span class="s2">&#39;, using default&quot;</span><span class="p">)</span>
                <span class="n">precision_value</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">precision_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_config_kwargs</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision_value</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">SFTConfig</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">SFTModelConfig</span><span class="p">(</span><span class="o">**</span><span class="n">model_config_kwargs</span><span class="p">),</span>
        <span class="n">dataset</span><span class="o">=</span><span class="n">SFTDatasetConfig</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">,</span>
            <span class="n">split</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;split&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">),</span>
            <span class="n">subset</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subset&#39;</span><span class="p">),</span>  <span class="c1"># Support dataset config/subset (e.g., for financial_phrasebank)</span>
            <span class="n">config</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">),</span>  <span class="c1"># Alternative name for subset</span>
            <span class="n">max_samples</span><span class="o">=</span><span class="n">max_samples</span><span class="p">,</span>
            <span class="n">percent</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;percent&#39;</span><span class="p">),</span>
            <span class="n">column_mapping</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column_mapping&#39;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">task_type</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task_type&#39;</span><span class="p">,</span> <span class="s1">&#39;supervised_fine_tuning&#39;</span><span class="p">),</span>
            <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
            <span class="c1"># dataset_kwargs=kwargs.get(&#39;dataset_kwargs&#39;, {}),</span>
            <span class="n">dataset_num_proc</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_num_proc&#39;</span><span class="p">),</span>
            <span class="n">dataset_text_field</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_text_field&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">),</span>
            <span class="n">text_column</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text_column&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_text_field&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)),</span>  <span class="c1"># For classification tasks</span>
            <span class="n">label_column</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label_column&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">),</span>  <span class="c1"># For classification tasks</span>
            <span class="c1"># eos_token=kwargs.get(&#39;eos_token&#39;),</span>
            <span class="n">pad_token</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pad_token&#39;</span><span class="p">),</span>
            <span class="n">chat_template</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chat_template&#39;</span><span class="p">),</span>


            <span class="n">preserve_columns</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;preserve_columns&#39;</span><span class="p">),</span>
            <span class="n">processing_fn</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;processing_fn&#39;</span><span class="p">),</span>
            <span class="n">processing_batched</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;processing_batched&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">processing_fn_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;processing_fn_kwargs&#39;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="p">),</span>
        <span class="n">train</span><span class="o">=</span><span class="n">SFTTrainingConfig</span><span class="p">(</span>
            <span class="n">epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
            <span class="n">max_steps</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_steps&#39;</span><span class="p">),</span>
            <span class="n">per_device_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
            <span class="n">gradient_accumulation_steps</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gradient_accumulation_steps&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">warmup_steps</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;warmup_steps&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">warmup_ratio</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;warmup_ratio&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="n">weight_decay</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
            <span class="n">eval_interval</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_interval&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">save_interval</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_steps&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_interval&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)),</span>
            <span class="n">max_grad_norm</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_grad_norm&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="n">fp16</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fp16&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">bf16</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bf16&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">dataloader_num_workers</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataloader_num_workers&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">remove_unused_columns</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remove_unused_columns&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimizer&#39;</span><span class="p">,</span> <span class="s1">&#39;adamw_torch&#39;</span><span class="p">),</span>
            <span class="n">lr_scheduler</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lr_scheduler&#39;</span><span class="p">,</span> <span class="s1">&#39;cosine&#39;</span><span class="p">),</span>
            <span class="n">group_by_length</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group_by_length&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">dataloader_drop_last</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataloader_drop_last&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">eval_accumulation_steps</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_accumulation_steps&#39;</span><span class="p">),</span>
            <span class="n">label_smoothing_factor</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label_smoothing_factor&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="n">early_stopping_patience</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;early_stopping_patience&#39;</span><span class="p">),</span>
            <span class="n">early_stopping_threshold</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;early_stopping_threshold&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="n">load_best_model_at_end</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;load_best_model_at_end&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">metric_for_best_model</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric_for_best_model&#39;</span><span class="p">,</span> <span class="s1">&#39;eval_loss&#39;</span><span class="p">),</span>
            <span class="n">greater_is_better</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;greater_is_better&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">use_trl</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_trl&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">dataset_num_proc</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;train_dataset_num_proc&#39;</span><span class="p">),</span>
            <span class="n">dataset_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;train_dataset_kwargs&#39;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">packing</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;packing&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">packing_strategy</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;packing_strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;bfd&#39;</span><span class="p">),</span>
            <span class="n">eval_packing</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_packing&#39;</span><span class="p">),</span>
            <span class="n">padding_free</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;padding_free&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">pad_to_multiple_of</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pad_to_multiple_of&#39;</span><span class="p">),</span>
            <span class="n">completion_only_loss</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;completion_only_loss&#39;</span><span class="p">),</span>
            <span class="n">assistant_only_loss</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;assistant_only_loss&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">loss_type</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loss_type&#39;</span><span class="p">,</span> <span class="s1">&#39;nll&#39;</span><span class="p">),</span>
            <span class="n">activation_offloading</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;activation_offloading&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">use_flash_attention_2</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_flash_attention_2&#39;</span><span class="p">),</span>
            <span class="n">gradient_checkpointing</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gradient_checkpointing&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">gradient_checkpointing_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gradient_checkpointing_kwargs&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;use_reentrant&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}),</span>
            <span class="n">extra_params</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> 
        <span class="p">),</span>
        <span class="n">logging</span><span class="o">=</span><span class="n">SFTLoggingConfig</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">run_name</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;run_name&#39;</span><span class="p">),</span>
            <span class="n">loggers</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loggers&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;tensorboard&quot;</span><span class="p">]),</span>
            <span class="n">log_level</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log_level&#39;</span><span class="p">,</span> <span class="s1">&#39;INFO&#39;</span><span class="p">),</span>
            <span class="n">log_interval</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logging_steps&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log_interval&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span>
            <span class="n">save_strategy</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;steps&#39;</span><span class="p">),</span>
            <span class="n">eval_strategy</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;steps&#39;</span><span class="p">),</span>
            <span class="n">report_to</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;report_to&#39;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">evaluation</span><span class="o">=</span><span class="n">SFTEvaluationConfig</span><span class="p">(</span>
            <span class="n">compute_perplexity</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compute_perplexity&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">compute_rouge</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compute_rouge&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">compute_bleu</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compute_bleu&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">compute_meteor</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compute_meteor&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">compute_bertscore</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compute_bertscore&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">compute_semantic_similarity</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compute_semantic_similarity&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">compute_codebleu</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compute_codebleu&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">max_samples_for_quality_metrics</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_samples_for_quality_metrics&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="n">bertscore_model</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bertscore_model&#39;</span><span class="p">,</span> <span class="s1">&#39;microsoft/deberta-xlarge-mnli&#39;</span><span class="p">),</span>
            <span class="n">semantic_similarity_model</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;semantic_similarity_model&#39;</span><span class="p">,</span> <span class="s1">&#39;sentence-transformers/all-MiniLM-L6-v2&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Create backend config</span>
    <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="n">backend_config</span> <span class="o">=</span> <span class="n">BackendFactory</span><span class="o">.</span><span class="n">get_recommended_backend</span><span class="p">(</span><span class="n">TrainingType</span><span class="o">.</span><span class="n">SFT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>  <span class="c1"># BackendType enum</span>
            <span class="n">backend_type</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># string</span>
            <span class="n">backend_type</span> <span class="o">=</span> <span class="n">BackendType</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">backend_config</span> <span class="o">=</span> <span class="n">BackendConfig</span><span class="p">(</span><span class="n">TrainingType</span><span class="o">.</span><span class="n">SFT</span><span class="p">,</span> <span class="n">backend_type</span><span class="p">)</span>

    <span class="c1"># Set PURE_TRL_MODE only when TRL backend is being used</span>
    <span class="k">if</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">TRL</span><span class="p">:</span>
        <span class="n">_disable_unsloth_backend</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Clear PURE_TRL_MODE for other backends (especially Unsloth)</span>
        <span class="n">_enable_unsloth_backend</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">BackendFactory</span><span class="o">.</span><span class="n">create_trainer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">backend_config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><p>options:
 show_source: true
 heading_level: 3</p>
<p><strong>Example</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">aligntune.core.backend_factory</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_sft_trainer</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">create_sft_trainer</span><span class="p">(</span>
 <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;meta-llama/Llama-3.2-3B-Instruct&quot;</span><span class="p">,</span>
 <span class="n">dataset_name</span><span class="o">=</span><span class="s2">&quot;tatsu-lab/alpaca&quot;</span><span class="p">,</span>
 <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;trl&quot;</span><span class="p">,</span>
 <span class="n">num_epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
 <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span>
<span class="p">)</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</code></pre></div>
<h3 id="create_rl_trainer"><code>create_rl_trainer()</code><a class="headerlink" href="#create_rl_trainer" title="Permanent link">&para;</a></h3>
<p>Create a Reinforcement Learning trainer.</p>


<div class="doc doc-object doc-function">



<a id="core.backend_factory.create_rl_trainer"></a>
    <div class="doc doc-contents first">

        <p>Create RL trainer with specified algorithm and backend.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_rl_trainer</span><span class="p">(</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dataset_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">algorithm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./output&quot;</span><span class="p">,</span>
    <span class="n">num_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">max_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>  <span class="c1"># Add max_steps parameter</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2e-4</span><span class="p">,</span>
    <span class="n">max_seq_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
    <span class="n">max_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reward_value_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reward_model_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># NEW</span>
    <span class="n">reward_model_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># NEW: Local reward model path</span>
    <span class="n">train_custom_reward_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># NEW: Train custom reward model</span>
    <span class="n">reward_training_texts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># NEW: Training texts for custom model</span>
    <span class="n">reward_functions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># NEW: Reward functions for custom model</span>
    <span class="n">reward_function_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># NEW: Weights for reward functions</span>
    <span class="n">reward_training_base_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># NEW: Base model for custom training</span>
    <span class="n">reward_training_output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># NEW: Output dir for custom training</span>
    <span class="n">reward_value_loading_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reward_model_quantization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">value_model_quantization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reward_training</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># NEW: Flexible reward training config</span>
    <span class="n">reward_device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">sample_logging</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># NEW: Counterfactual GRPO specific parameters</span>
    <span class="n">boost_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">min_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">max_spans</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">answer_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
    <span class="n">method_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;counterfactual&quot;</span><span class="p">,</span>
    <span class="n">random_importance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">invert_importance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">enable_gradient_conservation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">weight_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1">#</span>
    <span class="c1"># NEW: GBMPO-specific parameters</span>
    <span class="n">gbmpo_divergence_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TrainerBase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create RL trainer with specified algorithm and backend.&quot;&quot;&quot;</span>

    <span class="c1"># NEW: Load config if provided# Load and parse config if provided</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>  <span class="c1"># ← Use load_config from config_utils</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># Parse config to unified format</span>
        <span class="n">parsed_config</span> <span class="o">=</span> <span class="n">parse_config_to_unified</span><span class="p">(</span><span class="n">config_dict</span><span class="p">,</span> <span class="n">training_type</span><span class="o">=</span><span class="s2">&quot;rl&quot;</span><span class="p">)</span>  <span class="c1"># ← Use the function</span>

        <span class="c1"># Merge: parsed_config as base, kwargs override</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">parsed_config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">merged</span>

        <span class="c1"># Extract required parameters from merged config</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">dataset_name</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dataset_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithm</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;algorithm&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;backend&#39;</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>

    <span class="c1"># Validate required parameters</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;model_name must be provided either as argument or in config&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset_name must be provided either as argument or in config&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">algorithm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;algorithm must be provided either as argument or in config&quot;</span><span class="p">)</span>

    <span class="n">reward_device</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;reward_device&#39;</span><span class="p">,</span> <span class="n">reward_device</span> <span class="ow">or</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span>
    <span class="n">reward_device</span> <span class="o">=</span> <span class="n">reward_device</span> <span class="ow">or</span> <span class="s2">&quot;auto&quot;</span>

    <span class="n">sample_logging_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">base_sample_logging</span> <span class="o">=</span> <span class="n">sample_logging</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_logging_config&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">base_sample_logging</span><span class="p">:</span>
        <span class="n">sample_logging_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base_sample_logging</span><span class="p">)</span>
    <span class="n">inline_sample_logging</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enable_sample_logging&#39;</span><span class="p">),</span>
        <span class="s2">&quot;prompts&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_logging_prompts&#39;</span><span class="p">),</span>
        <span class="s2">&quot;interval_steps&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_logging_interval_steps&#39;</span><span class="p">),</span>
        <span class="s2">&quot;percent_of_max_steps&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_logging_percent_of_max_steps&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_logging_percent&#39;</span><span class="p">)),</span>
        <span class="s2">&quot;max_new_tokens&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_logging_max_new_tokens&#39;</span><span class="p">),</span>
        <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_logging_temperature&#39;</span><span class="p">),</span>
        <span class="s2">&quot;top_p&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_logging_top_p&#39;</span><span class="p">),</span>
        <span class="s2">&quot;num_samples&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_logging_num_samples&#39;</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">inline_sample_logging</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sample_logging_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">cleaned_sample_logging</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sample_logging_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">cleaned_sample_logging</span><span class="p">:</span>
        <span class="n">sample_logging_config</span> <span class="o">=</span> <span class="n">SampleLoggingConfig</span><span class="p">(</span><span class="o">**</span><span class="n">cleaned_sample_logging</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sample_logging_config</span> <span class="o">=</span> <span class="n">SampleLoggingConfig</span><span class="p">()</span>
    <span class="n">needs_neural_reward</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">reward_model_path</span><span class="p">,</span> <span class="n">train_custom_reward_model</span><span class="p">,</span> <span class="n">reward_functions</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">reward_model_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">needs_neural_reward</span><span class="p">:</span>
        <span class="n">reward_model_name</span> <span class="o">=</span> <span class="n">model_name</span>

    <span class="c1"># ============================================</span>
    <span class="c1"># PPO MODEL CONSISTENCY WARNING</span>
    <span class="c1"># ============================================</span>
    <span class="k">if</span> <span class="n">algorithm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ppo&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️  NOTE: For optimal PPO performance, ensure policy_model, reward_model, and value_model are from the same model family&quot;</span><span class="p">)</span>

    <span class="c1"># STRICT VALIDATION: Validate reward model configuration</span>
    <span class="n">reward_model_source</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">source_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span>
        <span class="n">reward_model_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reward_model_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">train_custom_reward_model</span>
    <span class="p">])</span>

    <span class="k">if</span> <span class="n">source_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Specify exactly ONE reward source. Found </span><span class="si">{</span><span class="n">source_count</span><span class="si">}</span><span class="s2">: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;reward_model_name=</span><span class="si">{</span><span class="n">reward_model_name</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;reward_model_path=</span><span class="si">{</span><span class="n">reward_model_path</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;train_custom_reward_model=</span><span class="si">{</span><span class="n">train_custom_reward_model</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">train_custom_reward_model</span><span class="p">:</span>
        <span class="c1"># Validate ALL required fields for custom training</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reward_training_texts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;reward_training_texts required when train_custom_reward_model=True&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reward_functions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;reward_functions required when train_custom_reward_model=True&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reward_training_base_model</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;reward_training_base_model required when train_custom_reward_model=True&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reward_training_output_dir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;reward_training_output_dir required when train_custom_reward_model=True&quot;</span><span class="p">)</span>

        <span class="c1"># Import required classes</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.rl.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">RewardModelTrainingConfig</span><span class="p">,</span> <span class="n">RewardModelSourceConfig</span>

        <span class="n">training_config</span> <span class="o">=</span> <span class="n">RewardModelTrainingConfig</span><span class="p">(</span>
            <span class="n">base_model_name</span><span class="o">=</span><span class="n">reward_training_base_model</span><span class="p">,</span>
            <span class="n">training_texts</span><span class="o">=</span><span class="n">reward_training_texts</span><span class="p">,</span>
            <span class="n">reward_functions</span><span class="o">=</span><span class="n">reward_functions</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">reward_training_output_dir</span><span class="p">,</span>
            <span class="c1"># Use kwargs for optional training params</span>
            <span class="n">num_epochs</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reward_training_epochs&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reward_training_lr&#39;</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">),</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reward_training_batch_size&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
            <span class="n">reward_weights</span> <span class="o">=</span> <span class="n">reward_function_weights</span>
        <span class="p">)</span>
        <span class="n">reward_model_source</span> <span class="o">=</span> <span class="n">RewardModelSourceConfig</span><span class="p">(</span>
            <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;custom_trained&quot;</span><span class="p">,</span>
            <span class="n">training_config</span><span class="o">=</span><span class="n">training_config</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">reward_model_name</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.rl.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">RewardModelSourceConfig</span>
        <span class="n">reward_model_source</span> <span class="o">=</span> <span class="n">RewardModelSourceConfig</span><span class="p">(</span>
            <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;pretrained_hf&quot;</span><span class="p">,</span>
            <span class="n">model_name</span><span class="o">=</span><span class="n">reward_model_name</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">reward_model_path</span><span class="p">:</span>
        <span class="c1"># Validate path exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">reward_model_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reward_model_path does not exist: </span><span class="si">{</span><span class="n">reward_model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.rl.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">RewardModelSourceConfig</span>
        <span class="n">reward_model_source</span> <span class="o">=</span> <span class="n">RewardModelSourceConfig</span><span class="p">(</span>
            <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;pretrained_local&quot;</span><span class="p">,</span>
            <span class="n">model_path</span><span class="o">=</span><span class="n">reward_model_path</span>
        <span class="p">)</span>

    <span class="c1"># Create reward training config if provided</span>
    <span class="n">reward_training_config</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">reward_training</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.rl.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">RewardModelTrainingConfig</span>
        <span class="n">reward_training_config</span> <span class="o">=</span> <span class="n">RewardModelTrainingConfig</span><span class="p">(</span><span class="o">**</span><span class="n">reward_training</span><span class="p">)</span>

    <span class="c1"># Construct rewards config if reward_functions provided but not in kwargs</span>
    <span class="c1"># rewards_config = kwargs.get(&#39;rewards&#39;, [])</span>
    <span class="n">rewards_config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rewards&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rewards_config</span> <span class="ow">and</span> <span class="n">reward_functions</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">train_custom_reward_model</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">reward_function_weights</span> <span class="ow">or</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">reward_functions</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reward_functions</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;reward_function_weights length mismatch, using default 1.0&quot;</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">reward_functions</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reward_functions</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
            <span class="n">rewards_config</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">func_name</span><span class="p">,</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
                <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">})</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Constructed rewards config from function list: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rewards_config</span><span class="p">)</span><span class="si">}</span><span class="s2"> functions&quot;</span><span class="p">)</span>

    <span class="c1"># FIXED: Added required &#39;algo&#39; parameter and used &#39;train&#39; not &#39;training&#39;</span>
    <span class="k">if</span> <span class="n">algorithm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;counterfact_grpo&quot;</span><span class="p">:</span>
        <span class="c1"># Add counterfactual-specific params to kwargs for config creation</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;boost_factor&#39;</span><span class="p">:</span> <span class="n">boost_factor</span><span class="p">,</span>
            <span class="s1">&#39;min_weight&#39;</span><span class="p">:</span> <span class="n">min_weight</span><span class="p">,</span>
            <span class="s1">&#39;max_spans&#39;</span><span class="p">:</span> <span class="n">max_spans</span><span class="p">,</span>
            <span class="s1">&#39;answer_weight&#39;</span><span class="p">:</span> <span class="n">answer_weight</span><span class="p">,</span>
            <span class="s1">&#39;method_name&#39;</span><span class="p">:</span> <span class="n">method_name</span><span class="p">,</span>
            <span class="s1">&#39;random_importance&#39;</span><span class="p">:</span> <span class="n">random_importance</span><span class="p">,</span>
            <span class="s1">&#39;invert_importance&#39;</span><span class="p">:</span> <span class="n">invert_importance</span><span class="p">,</span>
            <span class="s1">&#39;enable_gradient_conservation&#39;</span><span class="p">:</span> <span class="n">enable_gradient_conservation</span><span class="p">,</span>
            <span class="s1">&#39;weight_debug&#39;</span><span class="p">:</span> <span class="n">weight_debug</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="c1"># NEW: Handle GBMPO algorithms - set divergence_type based on algorithm</span>
    <span class="c1"># NEW: Handle GBMPO algorithm variants</span>
    <span class="n">original_algorithm</span> <span class="o">=</span> <span class="n">algorithm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Map GBMPO variants to base algorithm and extract divergence type</span>
    <span class="k">if</span> <span class="n">original_algorithm</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gbmpo&quot;</span><span class="p">):</span>
        <span class="c1"># Extract divergence type from algorithm name if not explicitly provided</span>
        <span class="k">if</span> <span class="n">gbmpo_divergence_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">original_algorithm</span> <span class="o">==</span> <span class="s2">&quot;gbmpo&quot;</span><span class="p">:</span>
                <span class="c1"># Default to l2kl if no variant specified</span>
                <span class="n">gbmpo_divergence_type</span> <span class="o">=</span> <span class="s2">&quot;l2kl&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Extract from algorithm name: gbmpo_l2kl -&gt; l2kl</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="n">original_algorithm</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;gbmpo_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">divergence_map</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;l2&quot;</span><span class="p">:</span> <span class="s2">&quot;l2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;l2kl&quot;</span><span class="p">:</span> <span class="s2">&quot;l2kl&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;probl2&quot;</span><span class="p">:</span> <span class="s2">&quot;prob_l2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;probl2kl&quot;</span><span class="p">:</span> <span class="s2">&quot;prob_l2kl&quot;</span>
                <span class="p">}</span>
                <span class="n">gbmpo_divergence_type</span> <span class="o">=</span> <span class="n">divergence_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="s2">&quot;l2kl&quot;</span><span class="p">)</span>

        <span class="c1"># Normalize to base &quot;gbmpo&quot; algorithm</span>
        <span class="n">algorithm</span> <span class="o">=</span> <span class="s2">&quot;gbmpo&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;gbmpo_divergence_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gbmpo_divergence_type</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GBMPO variant detected: </span><span class="si">{</span><span class="n">original_algorithm</span><span class="si">}</span><span class="s2"> -&gt; divergence_type=</span><span class="si">{</span><span class="n">gbmpo_divergence_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">UnifiedConfig</span><span class="p">(</span>
        <span class="n">algo</span><span class="o">=</span><span class="n">algorithm</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
        <span class="n">model</span><span class="o">=</span><span class="n">RLModelConfig</span><span class="p">(</span>
            <span class="n">name_or_path</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
            <span class="n">backend</span><span class="o">=</span><span class="n">backend</span> <span class="k">if</span> <span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;auto&quot;</span> <span class="k">else</span> <span class="s2">&quot;trl&quot;</span><span class="p">,</span>
            <span class="n">max_seq_length</span><span class="o">=</span><span class="n">max_seq_length</span><span class="p">,</span>
            <span class="n">quantization</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quantization&#39;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">gradient_checkpointing</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_gradient_checkpointing&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">precision</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">),</span>
            <span class="n">reward_value_model</span><span class="o">=</span><span class="n">reward_value_model</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reward_value_model&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">reward_model_name</span><span class="o">=</span><span class="n">reward_model_name</span><span class="p">,</span>
            <span class="n">reward_model_source</span><span class="o">=</span><span class="n">reward_model_source</span><span class="p">,</span>
            <span class="n">reward_value_loading_type</span><span class="o">=</span><span class="n">reward_value_loading_type</span><span class="p">,</span>
            <span class="n">reward_model_quantization</span><span class="o">=</span><span class="n">reward_model_quantization</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="n">value_model_quantization</span><span class="o">=</span><span class="n">value_model_quantization</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="n">use_peft</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_peft&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">lora_r</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lora_r&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
            <span class="n">lora_alpha</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lora_alpha&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
            <span class="n">lora_dropout</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lora_dropout&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
            <span class="n">lora_target_modules</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lora_target_modules&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;q_proj&quot;</span><span class="p">,</span> <span class="s2">&quot;k_proj&quot;</span><span class="p">,</span> <span class="s2">&quot;v_proj&quot;</span><span class="p">,</span> <span class="s2">&quot;o_proj&quot;</span><span class="p">]),</span>
            <span class="n">model_init_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_init_kwargs&#39;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">ref_model_init_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref_model_init_kwargs&#39;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">model_adapter_name</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_adapter_name&#39;</span><span class="p">),</span>
            <span class="n">ref_adapter_name</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref_adapter_name&#39;</span><span class="p">),</span>
            <span class="n">force_use_ref_model</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;force_use_ref_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">disable_dropout</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;disable_dropout&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">use_logits_to_keep</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_logits_to_keep&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">reward_device</span><span class="o">=</span><span class="n">reward_device</span><span class="p">,</span>
            <span class="n">device_map</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;device_map&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">),</span>
            <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trust_remote_code&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>

        <span class="p">),</span>
        <span class="n">datasets</span><span class="o">=</span><span class="p">[</span>
            <span class="n">RLDatasetConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">,</span>
                <span class="n">split</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;split&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">),</span>
                <span class="n">max_samples</span><span class="o">=</span><span class="n">max_samples</span><span class="p">,</span>
                <span class="n">percent</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;percent&#39;</span><span class="p">),</span>
                <span class="n">max_eval_samples</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_eval_samples&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">field_mappings</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;field_mappings&#39;</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="n">column_mapping</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column_mapping&#39;</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="n">weight</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_weight&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="n">dataset_num_proc</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_num_proc&#39;</span><span class="p">),</span>
                <span class="n">pad_token</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pad_token&#39;</span><span class="p">),</span>
                <span class="n">label_pad_token_id</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label_pad_token_id&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">),</span>
                <span class="n">truncation_mode</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;truncation_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;keep_end&#39;</span><span class="p">),</span>
                <span class="n">padding_free</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;padding_free&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="n">precompute_ref_log_probs</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;precompute_ref_log_probs&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="n">precompute_ref_batch_size</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;precompute_ref_batch_size&#39;</span><span class="p">),</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tools&#39;</span><span class="p">),</span>
                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>

                <span class="n">preserve_columns</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;preserve_columns&#39;</span><span class="p">),</span>
                <span class="n">processing_fn</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;processing_fn&#39;</span><span class="p">),</span>
                <span class="n">processing_batched</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;processing_batched&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="n">processing_fn_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;processing_fn_kwargs&#39;</span><span class="p">,</span> <span class="p">{}),</span>

                <span class="n">config_name</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config_name&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span>

            <span class="p">)</span>
        <span class="p">],</span>
        <span class="n">train</span><span class="o">=</span><span class="n">RLTrainingConfig</span><span class="p">(</span>
            <span class="n">epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
            <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span>
            <span class="n">per_device_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">per_device_eval_batch_size</span><span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_batch_size&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">),</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
            <span class="n">gradient_accumulation_steps</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gradient_accumulation_steps&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">beta</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>  <span class="c1"># YAML beta -&gt; config.train.beta</span>
            <span class="n">kl_coef</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kl_coef&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="n">num_generations</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_generations&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">),</span>
            <span class="n">cliprange</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cliprange&#39;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
            <span class="n">max_length</span><span class="o">=</span><span class="n">max_seq_length</span><span class="p">,</span>
            <span class="n">use_cache</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_cache&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">eval_interval</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_interval&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">save_interval</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_interval&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">save_steps</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_steps&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
            <span class="n">save_total_limit</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_total_limit&#39;</span><span class="p">),</span>
            <span class="n">save_strategy</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;steps&#39;</span><span class="p">),</span>
            <span class="n">logging_steps</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logging_steps&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="n">eval_steps</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_steps&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="mi">42</span><span class="p">),</span>
            <span class="n">data_seed</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_seed&#39;</span><span class="p">,</span> <span class="mi">47</span><span class="p">),</span>  <span class="c1"># Match training_script.py</span>
            <span class="n">mask_truncated_completions</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mask_truncated_completions&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">rollout_batch_size</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rollout_batch_size&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">num_ppo_epochs</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_ppo_epochs&#39;</span><span class="p">),</span>
            <span class="n">temperature</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span>
            <span class="n">top_p</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;top_p&#39;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
            <span class="n">max_grad_norm</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_grad_norm&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="n">whiten_rewards</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;whiten_rewards&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">kl_estimator</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kl_estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;k1&#39;</span><span class="p">),</span>
            <span class="n">vf_coef</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vf_coef&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="n">cliprange_value</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cliprange_value&#39;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
            <span class="n">gamma</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="n">lam</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lam&#39;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
            <span class="n">response_length</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response_length&#39;</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="n">stop_token</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stop_token&#39;</span><span class="p">,</span> <span class="s1">&#39;eos&#39;</span><span class="p">),</span>
            <span class="n">missing_eos_penalty</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;missing_eos_penalty&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="n">ds3_gather_for_generation</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ds3_gather_for_generation&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">generation_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;generation_kwargs&#39;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">max_prompt_length</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_prompt_length&#39;</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
            <span class="n">max_target_length</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_target_length&#39;</span><span class="p">),</span>
            <span class="n">max_completion_length</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_completion_length&#39;</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
            <span class="n">padding_free</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;padding_free&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">truncation_mode</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;truncation_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;keep_end&#39;</span><span class="p">),</span>
            <span class="n">loss_type</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loss_type&#39;</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">),</span>
            <span class="n">loss_weights</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loss_weights&#39;</span><span class="p">),</span>
            <span class="n">f_divergence_type</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;f_divergence_type&#39;</span><span class="p">,</span> <span class="s1">&#39;reverse_kl&#39;</span><span class="p">),</span>
            <span class="n">f_alpha_divergence_coef</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;f_alpha_divergence_coef&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="n">reference_free</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reference_free&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">label_smoothing</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label_smoothing&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="n">use_weighting</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_weighting&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">rpo_alpha</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rpo_alpha&#39;</span><span class="p">),</span>
            <span class="n">ld_alpha</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ld_alpha&#39;</span><span class="p">),</span>
            <span class="n">discopop_tau</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;discopop_tau&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
            <span class="n">sync_ref_model</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sync_ref_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">ref_model_mixup_alpha</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref_model_mixup_alpha&#39;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span>
            <span class="n">ref_model_sync_steps</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref_model_sync_steps&#39;</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
            <span class="n">use_liger_kernel</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_liger_kernel&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">use_liger_loss</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_liger_loss&#39;</span><span class="p">),</span>
            <span class="c1"># NEW: Counterfactual GRPO specific</span>
            <span class="n">boost_factor</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;boost_factor&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span>
            <span class="n">min_weight</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_weight&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
            <span class="n">max_spans</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_spans&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="n">answer_weight</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;answer_weight&#39;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>
            <span class="n">weighting_mode</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting_mode&#39;</span><span class="p">),</span>
            <span class="n">method_name</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method_name&#39;</span><span class="p">,</span> <span class="s1">&#39;counterfactual&#39;</span><span class="p">),</span>
            <span class="n">random_importance</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;random_importance&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">invert_importance</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;invert_importance&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">enable_gradient_conservation</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enable_gradient_conservation&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">weight_debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight_debug&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">scale_rewards</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scale_rewards&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">),</span>
            <span class="n">enable_thinking</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enable_thinking&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">fast_inference</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fast_inference&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>  <span class="c1"># Unsloth vLLM fast inference</span>
            <span class="n">vllm_gpu_memory_utilization</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vllm_gpu_memory_utilization&#39;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span>  <span class="c1"># vLLM GPU memory (0.95 for max speed)</span>
            <span class="n">gbmpo_l2_coefficient</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gbmpo_l2_coefficient&#39;</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">),</span>
            <span class="n">gbmpo_divergence_type</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gbmpo_divergence_type&#39;</span><span class="p">),</span>
            <span class="n">gbmpo_epsilon</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gbmpo_epsilon&#39;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimizer&#39;</span><span class="p">,</span> <span class="s1">&#39;adamw_torch&#39;</span><span class="p">),</span>
            <span class="n">lr_scheduler</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lr_scheduler&#39;</span><span class="p">,</span> <span class="s1">&#39;cosine&#39;</span><span class="p">),</span>
            <span class="n">warmup_steps</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;warmup_steps&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">warmup_ratio</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;warmup_ratio&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="n">eval_strategy</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">),</span>
            <span class="n">logging_strategy</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logging_strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;steps&#39;</span><span class="p">),</span>

            <span class="c1"># BOLT-specific parameters</span>
            <span class="n">curriculum_enabled</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;curriculum_enabled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">curriculum_epsilon</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;curriculum_epsilon&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
            <span class="n">curriculum_update_freq</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;curriculum_update_freq&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="n">baseline_enabled</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;baseline_enabled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">baseline_rho_min</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;baseline_rho_min&#39;</span><span class="p">,</span> <span class="mf">0.875</span><span class="p">),</span>
            <span class="n">baseline_rho_max</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;baseline_rho_max&#39;</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">),</span>
            <span class="n">baseline_D_half</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;baseline_D_half&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
            <span class="n">baseline_warm_start</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;baseline_warm_start&#39;</span><span class="p">),</span>
            <span class="n">use_baseline_advantages</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_baseline_advantages&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>

            <span class="c1"># Meta-ES specific parameters</span>
            <span class="n">meta_iterations</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;meta_iterations&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
            <span class="n">patience</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;patience&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="n">min_delta</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_delta&#39;</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">),</span>
            <span class="n">init_scale</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;init_scale&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
            <span class="n">N</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="n">T</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
            <span class="n">sigma_decay</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sigma_decay&#39;</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">),</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
            <span class="n">mirror_coefficient</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mirror_coefficient&#39;</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">),</span>
            <span class="n">debug_mode</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug_mode&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">eval_timeout</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_timeout&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="n">eval_max_tokens</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_max_tokens&#39;</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
            <span class="n">eval_k</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_k&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">eval_temperature</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_temperature&#39;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_workers&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">no_wandb</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_wandb&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">wandb_project</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wandb_project&#39;</span><span class="p">,</span> <span class="s1">&#39;neural-mirror-es&#39;</span><span class="p">),</span>
            <span class="n">resume</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resume&#39;</span><span class="p">),</span>

            <span class="c1"># DPO evaluation parameters</span>
            <span class="n">dpo_eval_enabled</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dpo_eval_enabled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">dpo_eval_max_samples</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dpo_eval_max_samples&#39;</span><span class="p">),</span>
            <span class="n">dpo_zero_shot_max_samples</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dpo_zero_shot_max_samples&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="n">dpo_few_shot_max_samples</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dpo_few_shot_max_samples&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
            <span class="n">dpo_few_shot_examples_text</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dpo_few_shot_examples_text&#39;</span><span class="p">),</span>

            <span class="c1"># Additional checkpoint parameters</span>
            <span class="n">load_best_model_at_end</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;load_best_model_at_end&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">metric_for_best_model</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric_for_best_model&#39;</span><span class="p">),</span>
            <span class="n">greater_is_better</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;greater_is_better&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>

            <span class="c1"># Additional training parameters</span>
            <span class="n">weight_decay</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
            <span class="n">reward_weights</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reward_weights&#39;</span><span class="p">),</span>

            <span class="c1"># GRPO/GSPO specific (if not already present)</span>
            <span class="n">grpo_alpha</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grpo_alpha&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="n">grpo_beta</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grpo_beta&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="n">gspo_gamma</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gspo_gamma&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="n">gspo_delta</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gspo_delta&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="n">group_by_length</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group_by_length&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">extra_params</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> 
            <span class="n">use_rewards_directly</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_rewards_directly&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>

        <span class="p">),</span>
        <span class="n">logging</span><span class="o">=</span><span class="n">RLLoggingConfig</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">run_name</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;run_name&#39;</span><span class="p">),</span>
            <span class="n">loggers</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loggers&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;tensorboard&quot;</span><span class="p">]),</span>
            <span class="n">sample_logging</span><span class="o">=</span><span class="n">sample_logging_config</span><span class="p">,</span>
            <span class="n">report_to</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;report_to&#39;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">rewards</span><span class="o">=</span><span class="n">rewards_config</span><span class="p">,</span>
        <span class="n">chat_template</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chat_template&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">),</span>
        <span class="n">caching</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;cache&#39;</span><span class="p">),</span>
            <span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;caching_enabled&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="n">reward_training</span><span class="o">=</span><span class="n">reward_training_config</span>
    <span class="p">)</span>

    <span class="c1"># Create backend config</span>
    <span class="n">algorithm_enum</span> <span class="o">=</span> <span class="n">RLAlgorithm</span><span class="p">(</span><span class="n">algorithm</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="n">backend_config</span> <span class="o">=</span> <span class="n">BackendFactory</span><span class="o">.</span><span class="n">get_recommended_backend</span><span class="p">(</span><span class="n">TrainingType</span><span class="o">.</span><span class="n">RL</span><span class="p">,</span> <span class="n">algorithm_enum</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>  <span class="c1"># BackendType enum</span>
            <span class="n">backend_type</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># string</span>
            <span class="n">backend_type</span> <span class="o">=</span> <span class="n">BackendType</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">backend_config</span> <span class="o">=</span> <span class="n">BackendConfig</span><span class="p">(</span><span class="n">TrainingType</span><span class="o">.</span><span class="n">RL</span><span class="p">,</span> <span class="n">backend_type</span><span class="p">,</span> <span class="n">algorithm_enum</span><span class="p">)</span>

    <span class="c1"># Set PURE_TRL_MODE only when TRL backend is being used</span>
    <span class="k">if</span> <span class="n">backend_config</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="n">BackendType</span><span class="o">.</span><span class="n">TRL</span><span class="p">:</span>
        <span class="n">_disable_unsloth_backend</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Clear PURE_TRL_MODE for other backends (especially Unsloth)</span>
        <span class="n">_enable_unsloth_backend</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">BackendFactory</span><span class="o">.</span><span class="n">create_trainer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">backend_config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><p>options:
 show_source: true
 heading_level: 3</p>
<p><strong>Example</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">aligntune.core.backend_factory</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_rl_trainer</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">create_rl_trainer</span><span class="p">(</span>
 <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;microsoft/DialoGPT-medium&quot;</span><span class="p">,</span>
 <span class="n">dataset_name</span><span class="o">=</span><span class="s2">&quot;Anthropic/hh-rlhf&quot;</span><span class="p">,</span>
 <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;dpo&quot;</span><span class="p">,</span>
 <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;trl&quot;</span><span class="p">,</span>
 <span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</code></pre></div>
<h3 id="get_backend_status"><code>get_backend_status()</code><a class="headerlink" href="#get_backend_status" title="Permanent link">&para;</a></h3>
<p>Get the availability status of all backends.</p>


<div class="doc doc-object doc-function">



<a id="core.backend_factory.get_backend_status"></a>
    <div class="doc doc-contents first">

        <p>Get current backend status and environment variables.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_backend_status</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get current backend status and environment variables.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;pure_trl_mode&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PURE_TRL_MODE&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span>
        <span class="s2">&quot;trl_only_mode&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TRL_ONLY_MODE&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span>
        <span class="s2">&quot;disable_unsloth_for_trl&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DISABLE_UNSLOTH_FOR_TRL&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span>
        <span class="s2">&quot;trl_available&quot;</span><span class="p">:</span> <span class="n">TRL_AVAILABLE</span><span class="p">,</span>
        <span class="s2">&quot;unsloth_available&quot;</span><span class="p">:</span> <span class="n">_check_backend_availability</span><span class="p">(</span><span class="n">BackendType</span><span class="o">.</span><span class="n">UNSLOTH</span><span class="p">),</span>
        <span class="s2">&quot;current_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;TRL-ONLY&quot;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PURE_TRL_MODE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span> <span class="k">else</span> <span class="s2">&quot;UNSLOTH-ENABLED&quot;</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><p>options:
 show_source: true
 heading_level: 3</p>
<p><strong>Example</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">aligntune.core.backend_factory</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_backend_status</span>

<span class="n">status</span> <span class="o">=</span> <span class="n">get_backend_status</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TRL available: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;trl_available&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsloth available: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;unsloth_available&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="list_backends"><code>list_backends()</code><a class="headerlink" href="#list_backends" title="Permanent link">&para;</a></h3>
<p>List all available backends.</p>


<div class="doc doc-object doc-function">



<a id="core.backend_factory.list_backends"></a>
    <div class="doc doc-contents first">


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_backends</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
    <span class="n">backends</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;TRL&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;available&quot;</span><span class="p">:</span> <span class="n">TRL_AVAILABLE</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;HuggingFace Transformers Reinforcement Learning library&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;✅ Available&quot;</span> <span class="k">if</span> <span class="n">TRL_AVAILABLE</span> <span class="k">else</span> <span class="s2">&quot;❌ Not Available&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;UNSLOTH&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;available&quot;</span><span class="p">:</span> <span class="n">_check_backend_availability</span><span class="p">(</span><span class="n">BackendType</span><span class="o">.</span><span class="n">UNSLOTH</span><span class="p">),</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Unsloth optimized training with memory efficiency&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;✅ Available&quot;</span> <span class="k">if</span> <span class="n">_check_backend_availability</span><span class="p">(</span><span class="n">BackendType</span><span class="o">.</span><span class="n">UNSLOTH</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;❌ Not Available&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1"># Print availability status</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FINETUNEHUB - BACKEND AVAILABILITY&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">backend_name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">backends</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">backend_name</span><span class="si">:</span><span class="s2">10s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;             </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Note: When TRL is selected, Unsloth is disabled to prevent interference.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;      When Unsloth is selected, TRL-only mode is cleared.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">backends</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><p>options:
 show_source: true
 heading_level: 3</p>
<hr />
<h2 id="enums-and-types">Enums and Types<a class="headerlink" href="#enums-and-types" title="Permanent link">&para;</a></h2>
<h3 id="backendtype-enum"><code>BackendType</code> Enum<a class="headerlink" href="#backendtype-enum" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-class">



<a id="core.backend_factory.BackendType"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="enum.Enum">Enum</span></code></p>



        <p>Backend types for training.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BackendType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Backend types for training.&quot;&quot;&quot;</span>
    <span class="n">UNSLOTH</span> <span class="o">=</span> <span class="s2">&quot;unsloth&quot;</span>  <span class="c1"># Unsloth backend (fast, memory efficient)</span>
    <span class="n">TRL</span> <span class="o">=</span> <span class="s2">&quot;trl&quot;</span>          <span class="c1"># TRL backend (standard, reliable)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div><p>options:
 show_source: true
 heading_level: 3</p>
<h3 id="trainingtype-enum"><code>TrainingType</code> Enum<a class="headerlink" href="#trainingtype-enum" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-class">



<a id="core.backend_factory.TrainingType"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="enum.Enum">Enum</span></code></p>



        <p>Training types supported by AlignTune.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TrainingType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Training types supported by AlignTune.&quot;&quot;&quot;</span>

    <span class="n">SFT</span> <span class="o">=</span> <span class="s2">&quot;sft&quot;</span>  <span class="c1"># Supervised Fine-Tuning</span>
    <span class="n">RL</span> <span class="o">=</span> <span class="s2">&quot;rl&quot;</span>    <span class="c1"># Reinforcement Learning</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div><p>options:
 show_source: true
 heading_level: 3</p>
<h3 id="rlalgorithm-enum"><code>RLAlgorithm</code> Enum<a class="headerlink" href="#rlalgorithm-enum" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-class">



<a id="core.backend_factory.RLAlgorithm"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="enum.Enum">Enum</span></code></p>



        <p>RL algorithms supported.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RLAlgorithm</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RL algorithms supported.&quot;&quot;&quot;</span>
    <span class="n">DPO</span> <span class="o">=</span> <span class="s2">&quot;dpo&quot;</span>    <span class="c1"># Direct Preference Optimization</span>
    <span class="n">PPO</span> <span class="o">=</span> <span class="s2">&quot;ppo&quot;</span>    <span class="c1"># Proximal Policy Optimization</span>
    <span class="n">GRPO</span> <span class="o">=</span> <span class="s2">&quot;grpo&quot;</span>  <span class="c1"># Group Relative Policy Optimization</span>
    <span class="n">GSPO</span> <span class="o">=</span> <span class="s2">&quot;gspo&quot;</span>  <span class="c1"># Generalized Scoring Proximal Objective</span>
    <span class="c1"># New</span>
    <span class="n">COUNTERFACT_GRPO</span> <span class="o">=</span> <span class="s2">&quot;counterfact_grpo&quot;</span> 
    <span class="c1"># NEW: Add GBMPO </span>
    <span class="n">GBMPO</span> <span class="o">=</span> <span class="s2">&quot;gbmpo&quot;</span>
    <span class="n">DRGRPO</span> <span class="o">=</span> <span class="s2">&quot;drgrpo&quot;</span>
    <span class="n">DAPO</span> <span class="o">=</span> <span class="s2">&quot;dapo&quot;</span>
    <span class="n">BOLT</span> <span class="o">=</span> <span class="s2">&quot;bolt&quot;</span>  <span class="c1"># Baseline-Optimized Learning Technique</span>
    <span class="n">NMGRPO</span> <span class="o">=</span> <span class="s2">&quot;nmgrpo&quot;</span>
    <span class="n">METAES</span> <span class="o">=</span> <span class="s2">&quot;metaes&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div><p>options:
 show_source: true
 heading_level: 3</p>
<h3 id="backendconfig-dataclass"><code>BackendConfig</code> Dataclass<a class="headerlink" href="#backendconfig-dataclass" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-class">



<a id="core.backend_factory.BackendConfig"></a>
    <div class="doc doc-contents first">



        <p>Configuration for backend selection with task type support.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BackendConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for backend selection with task type support.&quot;&quot;&quot;</span>
    <span class="n">training_type</span><span class="p">:</span> <span class="n">TrainingType</span>
    <span class="n">backend</span><span class="p">:</span> <span class="n">BackendType</span>
    <span class="n">algorithm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RLAlgorithm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Only for RL</span>
    <span class="n">task_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TaskType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># NEW: For SFT tasks</span>
    <span class="n">fallback_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate configuration.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_type</span> <span class="o">==</span> <span class="n">TrainingType</span><span class="o">.</span><span class="n">RL</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;RL training requires algorithm specification&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_type</span> <span class="o">==</span> <span class="n">TrainingType</span><span class="o">.</span><span class="n">SFT</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Algorithm specified for SFT training, ignoring&quot;</span><span class="p">)</span>

        <span class="c1"># NEW: Set default task type for SFT if not specified</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_type</span> <span class="o">==</span> <span class="n">TrainingType</span><span class="o">.</span><span class="n">SFT</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No task type specified for SFT, using default SUPERVISED_FINE_TUNING&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">TaskType</span><span class="o">.</span><span class="n">SUPERVISED_FINE_TUNING</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="core.backend_factory.BackendConfig.__post_init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__post_init__</span><span class="p">()</span></code>

<a href="#core.backend_factory.BackendConfig.__post_init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Validate configuration.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/aligntune/core/backend_factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate configuration.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_type</span> <span class="o">==</span> <span class="n">TrainingType</span><span class="o">.</span><span class="n">RL</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;RL training requires algorithm specification&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_type</span> <span class="o">==</span> <span class="n">TrainingType</span><span class="o">.</span><span class="n">SFT</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Algorithm specified for SFT training, ignoring&quot;</span><span class="p">)</span>

    <span class="c1"># NEW: Set default task type for SFT if not specified</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_type</span> <span class="o">==</span> <span class="n">TrainingType</span><span class="o">.</span><span class="n">SFT</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No task type specified for SFT, using default SUPERVISED_FINE_TUNING&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">TaskType</span><span class="o">.</span><span class="n">SUPERVISED_FINE_TUNING</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>options:
 show_source: true
 heading_level: 3</p>
<h2 id="examples">Examples<a class="headerlink" href="#examples" title="Permanent link">&para;</a></h2>
<h3 id="sft-with-trl-backend">SFT with TRL Backend<a class="headerlink" href="#sft-with-trl-backend" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">trainer</span> <span class="o">=</span> <span class="n">create_sft_trainer</span><span class="p">(</span>
 <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;microsoft/DialoGPT-small&quot;</span><span class="p">,</span>
 <span class="n">dataset_name</span><span class="o">=</span><span class="s2">&quot;tatsu-lab/alpaca&quot;</span><span class="p">,</span>
 <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;trl&quot;</span>
<span class="p">)</span>
</code></pre></div>
<h3 id="sft-with-unsloth-backend">SFT with Unsloth Backend<a class="headerlink" href="#sft-with-unsloth-backend" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">trainer</span> <span class="o">=</span> <span class="n">create_sft_trainer</span><span class="p">(</span>
 <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;unsloth/Llama-3.2-1B-Instruct-bnb-4bit&quot;</span><span class="p">,</span>
 <span class="n">dataset_name</span><span class="o">=</span><span class="s2">&quot;tatsu-lab/alpaca&quot;</span><span class="p">,</span>
 <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;unsloth&quot;</span>
<span class="p">)</span>
</code></pre></div>
<h3 id="dpo-training">DPO Training<a class="headerlink" href="#dpo-training" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">trainer</span> <span class="o">=</span> <span class="n">create_rl_trainer</span><span class="p">(</span>
 <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;microsoft/DialoGPT-medium&quot;</span><span class="p">,</span>
 <span class="n">dataset_name</span><span class="o">=</span><span class="s2">&quot;Anthropic/hh-rlhf&quot;</span><span class="p">,</span>
 <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;dpo&quot;</span><span class="p">,</span>
 <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;trl&quot;</span>
<span class="p">)</span>
</code></pre></div>
<h3 id="ppo-training">PPO Training<a class="headerlink" href="#ppo-training" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">trainer</span> <span class="o">=</span> <span class="n">create_rl_trainer</span><span class="p">(</span>
 <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;unsloth/Llama-3.2-1B-Instruct-bnb-4bit&quot;</span><span class="p">,</span>
 <span class="n">dataset_name</span><span class="o">=</span><span class="s2">&quot;Anthropic/hh-rlhf&quot;</span><span class="p">,</span>
 <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;ppo&quot;</span><span class="p">,</span>
 <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;unsloth&quot;</span>
<span class="p">)</span>
</code></pre></div>
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h2>
<h3 id="backend-not-available">Backend Not Available<a class="headerlink" href="#backend-not-available" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
 <span class="n">trainer</span> <span class="o">=</span> <span class="n">create_sft_trainer</span><span class="p">(</span>
 <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;microsoft/DialoGPT-small&quot;</span><span class="p">,</span>
 <span class="n">dataset_name</span><span class="o">=</span><span class="s2">&quot;tatsu-lab/alpaca&quot;</span><span class="p">,</span>
 <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;unsloth&quot;</span>
 <span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
 <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backend not available: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
 <span class="c1"># Falls back to TRL automatically</span>
</code></pre></div>
<h3 id="invalid-algorithm">Invalid Algorithm<a class="headerlink" href="#invalid-algorithm" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
 <span class="n">trainer</span> <span class="o">=</span> <span class="n">create_rl_trainer</span><span class="p">(</span>
 <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;microsoft/DialoGPT-medium&quot;</span><span class="p">,</span>
 <span class="n">dataset_name</span><span class="o">=</span><span class="s2">&quot;Anthropic/hh-rlhf&quot;</span><span class="p">,</span>
 <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;invalid&quot;</span>
 <span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
 <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid algorithm: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h2 id="next-steps">Next Steps<a class="headerlink" href="#next-steps" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="../configuration/">Configuration Classes</a> - Configuration options</li>
<li><a href="../trainers/">Trainers</a> - Trainer methods</li>
<li><a href="../../user-guide/sft/">User Guide</a> - Usage guide</li>
</ul></div>
        
        
    </div>

    
      <footer class="col-md-12 text-center">
          
          
            <hr>
            <p>
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</small>
            </p>
          

          
          
      </footer>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js"></script>
        
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/python.min.js"></script>
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/yaml.min.js"></script>
        
    <script>hljs.initHighlightingOnLoad();</script>
    

    <script>var base_url = "../.."</script>
    
    <script src="../../js/base.js"></script>
    <script src="../../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>
